---
import Time from "../utils/time";

let {
  posts,
  textColor = "var(--fish-font-color)",
  backgroundColor = "var(--fish-background-color)",
  weeks = 20,
} = Astro.props;

const locale = "zh-cn"; // 当前语言

const days = weeks * 7; // 转换成天数

// 以本周六为参考点
const now = new Date();
const start = Time.addDays(now, (6 - Time.weekday(now)) % 7);

// 创建 heatmap 数据结构，每天包含日期和 posts 数组
const heatmap = Array.from({ length: days }, (_, day) => ({
  date: Time.subtractDays(start, day),
  posts: [] as typeof posts,
}));

// 填充 heatmap 数据
posts.forEach((post: any) => {
  const gap = Time.diffDays(start, post.data.timestamp);
  if (0 <= gap && gap < days) heatmap[gap].posts.push(post);
});

// 将数据倒序显示（从最早到最晚）
const reversedHeatmap = heatmap.reverse();
---

<style define:vars={{ textColor, backgroundColor }}>
  /* 栅格布局：7 行，列流 */
  .heatmap {
    display: grid;
    grid-template-rows: repeat(7, 1fr);
    grid-auto-flow: column;
    gap: 0.25rem;
  }

  /* 每个小格子 */
  .heatmap-cell {
    width: 10px;
    height: 10px;
    background-color: var(--backgroundColor);
    border-radius: 2px;
    opacity: 0.1;
    position: relative;
  }

  /* 不同数量的文章对应不同透明度 */
  .heatmap-cell[data-count="0"] {
    opacity: 0.1;
  }
  .heatmap-cell[data-count="1"] {
    opacity: 0.4;
  }
  .heatmap-cell[data-count="2"] {
    opacity: 0.7;
  }
  .heatmap-cell[data-count="3"] {
    opacity: 1;
  }

  /* Tooltip 样式 */
  .heatmap-tooltip {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    margin-bottom: 0.25rem;
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    background-color: var(--tooltip-bg, #1f2937);
    color: white;
    border-radius: 4px;
    display: none;
    flex-direction: column;
    z-index: 10;
    white-space: nowrap;
  }

  .heatmap-cell:hover .heatmap-tooltip {
    display: flex;
  }

  /* Tooltip 内的链接 */
  .heatmap-tooltip a {
    color: var(--textColor);
    text-decoration: none;
    margin-left: 0.25rem;
  }

  .heatmap-tooltip a:hover {
    text-decoration: underline;
  }
</style>

<section class="heatmap">
  {
    reversedHeatmap.map((day) => {
      const count = day.posts.length;
      return (
        <div class="heatmap-cell" data-count={count}>
          <div class="heatmap-tooltip">
            <time>{Time.date.locale(day.date, locale)}</time>
            {count > 0 ? (
              <>
                <p>{count}篇文章</p>
                <ul>
                  {day.posts.map((post: any) => (
                    <li>
                      <a
                        href={`/posts/${post.slug}`}
                        aria-label={post.data.title}
                      >
                        {post.data.title}
                      </a>
                    </li>
                  ))}
                </ul>
              </>
            ) : (
              <p>神马都没有~</p>
            )}
          </div>
        </div>
      );
    })
  }
</section>
