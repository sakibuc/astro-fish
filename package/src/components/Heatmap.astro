---
import Time from "../utils/time";

let {
  posts,
  textColor = "var(--fish-light-color)",
  backgroundColor = "var(--fish-highlight-color)",
  weeks = 20,
} = Astro.props;

const locale = "zh-cn"; // 当前语言

const days = weeks * 7;

// 以本周六为参考点
const now = new Date();
const start = Time.addDays(now, (6 - Time.weekday(now)) % 7);

// heatmap 数据
const heatmap = Array.from({ length: days }, (_, day) => ({
  date: Time.subtractDays(start, day),
  posts: [] as typeof posts,
}));

posts.forEach((post: any) => {
  const gap = Time.diffDays(start, post.data.published);
  if (0 <= gap && gap < days) heatmap[gap].posts.push(post);
});

// 从早到晚
const reversedHeatmap = heatmap.reverse();
---

<style define:vars={{ textColor, backgroundColor }}>
  .heatmap {
    display: grid;
    grid-template-rows: repeat(7, 1fr);
    grid-auto-flow: column;
    gap: 0.2rem;
    position: relative;
  }

  .heatmap-cell {
    width: 10px;
    height: 10px;
    background-color: var(--backgroundColor);
    border-radius: 2px;
    opacity: 0.1;
    position: relative;
    cursor: pointer;
  }

  .heatmap-cell[data-count="1"] {
    opacity: 0.4;
  }
  .heatmap-cell[data-count="2"] {
    opacity: 0.7;
  }
  .heatmap-cell[data-count="3"] {
    opacity: 1;
  }

  /* Tooltip */
  .heatmap-tooltip {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    margin-bottom: 0.25rem;
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    background-color: var(--backgroundColor);
    color: white;
    border-radius: 4px;
    display: none;
    white-space: nowrap;
    z-index: 10;
  }

  .heatmap-cell:hover .heatmap-tooltip {
    display: block;
  }

  /* 下方展示框 */
  #heatmap-detail {
    margin-top: 1rem;
    padding: 1rem;
    border-radius: 6px;
    background-color: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  #heatmap-detail h4 {
    margin-top: 0;
  }

  #heatmap-detail ul {
    padding-left: 1rem;
    margin: 0.25rem 0 0;
  }

  #heatmap-detail a {
    color: var(--textColor);
    text-decoration: none;
  }

  #heatmap-detail a:hover {
    text-decoration: underline;
  }
</style>

<section class="heatmap" id="heatmap">
  {
    reversedHeatmap.map((day, index) => {
      const count = day.posts.length;
      return (
        <div class="heatmap-cell" data-count={count} data-index={index}>
          <div class="heatmap-tooltip">
            <time>{Time.date.locale(day.date, locale)}</time>
            {count > 0 ? <p>{count} 篇文章</p> : <p>"这一天什么都没有~"</p>}
          </div>
        </div>
      );
    })
  }
</section>

<div id="heatmap-detail" style="display:none;"></div>

<script>
  const heatmapData = JSON.parse(String.raw`{JSON.stringify(reversedHeatmap)}`);
  const heatmapEl = document.getElementById("heatmap");
  const detailEl = document.getElementById("heatmap-detail");

  heatmapEl.addEventListener("click", (e) => {
    const target = e.target as HTMLElement; // 类型断言
    const cell = target.closest(".heatmap-cell") as HTMLElement | null;
    if (!cell) return;

    const index = Number(cell.dataset.index);
    const data = heatmapData[index];
    const count = data.posts.length;

    // 构造展示内容
    detailEl.style.display = "block";
    detailEl.innerHTML = `
      <h4>${new Date(data.date).toLocaleDateString("zh-CN")}</h4>
      ${
        count > 0
          ? `<p>共 ${count} 篇文章</p>
            <ul>${data.posts
              .map(
                (p) =>
                  `<li><a href="/posts/${p.slug}" target="_blank">${p.data.title}</a></li>`,
              )
              .join("")}</ul>`
          : `<p>这一天什么都没有~</p>`
      }
    `;
  });
</script>
